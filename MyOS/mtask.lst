     1 00000000                                 [FORMAT "WCOFF"]
     2 00000000                                 [INSTRSET "i486p"]
     3 00000000                                 [OPTIMIZE 1]
     4 00000000                                 [OPTION 1]
     5 00000000                                 [BITS 32]
     6 00000000                                 	EXTERN	_io_hlt
     7 00000000                                 	EXTERN	_mm_malloc
     8 00000000                                 	EXTERN	_set_segmdesc
     9 00000000                                 	EXTERN	_load_tr
    10 00000000                                 	EXTERN	_fifo_init
    11 00000000                                 	EXTERN	_farjmp
    12 00000000                                 [FILE "mtask.c"]
    13 00000000                                 	GLOBAL	_mtask_on
    14                                          [SECTION .data]
    15 00000000                                 _mtask_on:
    16 00000000 00                              	DB	0
    17                                          [SECTION .text]
    18 00000000                                 	GLOBAL	_task_now
    19 00000000                                 _task_now:
    20 00000000 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
    21 00000005 55                              	PUSH	EBP
    22 00000006 89 E5                           	MOV	EBP,ESP
    23 00000008 5D                              	POP	EBP
    24 00000009 8B 10                           	MOV	EDX,DWORD [EAX]
    25 0000000B 69 D2 00000198                  	IMUL	EDX,EDX,408
    26 00000011 8D 44 02 08                     	LEA	EAX,DWORD [8+EDX+EAX*1]
    27 00000015 8B 50 04                        	MOV	EDX,DWORD [4+EAX]
    28 00000018 8B 44 90 08                     	MOV	EAX,DWORD [8+EAX+EDX*4]
    29 0000001C C3                              	RET
    30 0000001D                                 _task_add:
    31 0000001D 55                              	PUSH	EBP
    32 0000001E 89 E5                           	MOV	EBP,ESP
    33 00000020 53                              	PUSH	EBX
    34 00000021 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
    35 00000024 8B 53 0C                        	MOV	EDX,DWORD [12+EBX]
    36 00000027 69 D2 00000198                  	IMUL	EDX,EDX,408
    37 0000002D 03 15 [00000008]                	ADD	EDX,DWORD [_taskctl]
    38 00000033 8B 42 08                        	MOV	EAX,DWORD [8+EDX]
    39 00000036 8D 4A 08                        	LEA	ECX,DWORD [8+EDX]
    40 00000039 83 F8 63                        	CMP	EAX,99
    41 0000003C 7F 0F                           	JG	L2
    42 0000003E 89 5C 81 08                     	MOV	DWORD [8+ECX+EAX*4],EBX
    43 00000042 40                              	INC	EAX
    44 00000043 89 42 08                        	MOV	DWORD [8+EDX],EAX
    45 00000046 C7 43 04 00000002               	MOV	DWORD [4+EBX],2
    46 0000004D                                 L2:
    47 0000004D 5B                              	POP	EBX
    48 0000004E 5D                              	POP	EBP
    49 0000004F C3                              	RET
    50 00000050                                 _task_remove:
    51 00000050 55                              	PUSH	EBP
    52 00000051 31 C9                           	XOR	ECX,ECX
    53 00000053 89 E5                           	MOV	EBP,ESP
    54 00000055 53                              	PUSH	EBX
    55 00000056 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
    56 00000059 8B 43 0C                        	MOV	EAX,DWORD [12+EBX]
    57 0000005C 69 C0 00000198                  	IMUL	EAX,EAX,408
    58 00000062 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
    59 00000068 8D 50 08                        	LEA	EDX,DWORD [8+EAX]
    60 0000006B 3B 48 08                        	CMP	ECX,DWORD [8+EAX]
    61 0000006E 7D 0B                           	JGE	L6
    62 00000070                                 L10:
    63 00000070 39 5C 8A 08                     	CMP	DWORD [8+EDX+ECX*4],EBX
    64 00000074 74 05                           	JE	L6
    65 00000076 41                              	INC	ECX
    66 00000077 3B 0A                           	CMP	ECX,DWORD [EDX]
    67 00000079 7C F5                           	JL	L10
    68 0000007B                                 L6:
    69 0000007B 8B 42 04                        	MOV	EAX,DWORD [4+EDX]
    70 0000007E FF 0A                           	DEC	DWORD [EDX]
    71 00000080 39 C1                           	CMP	ECX,EAX
    72 00000082 7D 04                           	JGE	L11
    73 00000084 48                              	DEC	EAX
    74 00000085 89 42 04                        	MOV	DWORD [4+EDX],EAX
    75 00000088                                 L11:
    76 00000088 8B 02                           	MOV	EAX,DWORD [EDX]
    77 0000008A 39 42 04                        	CMP	DWORD [4+EDX],EAX
    78 0000008D 7C 07                           	JL	L12
    79 0000008F C7 42 04 00000000               	MOV	DWORD [4+EDX],0
    80 00000096                                 L12:
    81 00000096 C7 43 04 00000001               	MOV	DWORD [4+EBX],1
    82 0000009D 8B 1A                           	MOV	EBX,DWORD [EDX]
    83 0000009F 39 D9                           	CMP	ECX,EBX
    84 000000A1 7D 0D                           	JGE	L20
    85 000000A3                                 L17:
    86 000000A3 8B 44 8A 0C                     	MOV	EAX,DWORD [12+EDX+ECX*4]
    87 000000A7 89 44 8A 08                     	MOV	DWORD [8+EDX+ECX*4],EAX
    88 000000AB 41                              	INC	ECX
    89 000000AC 39 D9                           	CMP	ECX,EBX
    90 000000AE 7C F3                           	JL	L17
    91 000000B0                                 L20:
    92 000000B0 5B                              	POP	EBX
    93 000000B1 5D                              	POP	EBP
    94 000000B2 C3                              	RET
    95 000000B3                                 _task_switchsub:
    96 000000B3 55                              	PUSH	EBP
    97 000000B4 31 C9                           	XOR	ECX,ECX
    98 000000B6 89 E5                           	MOV	EBP,ESP
    99 000000B8 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
   100 000000BD 31 D2                           	XOR	EDX,EDX
   101 000000BF                                 L27:
   102 000000BF 83 7C 10 08 00                  	CMP	DWORD [8+EAX+EDX*1],0
   103 000000C4 7F 0C                           	JG	L23
   104 000000C6 41                              	INC	ECX
   105 000000C7 81 C2 00000198                  	ADD	EDX,408
   106 000000CD 83 F9 09                        	CMP	ECX,9
   107 000000D0 7E ED                           	JLE	L27
   108 000000D2                                 L23:
   109 000000D2 89 08                           	MOV	DWORD [EAX],ECX
   110 000000D4 C6 40 04 00                     	MOV	BYTE [4+EAX],0
   111 000000D8 5D                              	POP	EBP
   112 000000D9 C3                              	RET
   113 000000DA                                 _task_idle:
   114 000000DA 55                              	PUSH	EBP
   115 000000DB 89 E5                           	MOV	EBP,ESP
   116 000000DD                                 L33:
   117 000000DD E8 [00000000]                   	CALL	_io_hlt
   118 000000E2 EB F9                           	JMP	L33
   119 000000E4                                 	GLOBAL	_task_init
   120 000000E4                                 _task_init:
   121 000000E4 55                              	PUSH	EBP
   122 000000E5 89 E5                           	MOV	EBP,ESP
   123 000000E7 57                              	PUSH	EDI
   124 000000E8 56                              	PUSH	ESI
   125 000000E9 31 FF                           	XOR	EDI,EDI
   126 000000EB 53                              	PUSH	EBX
   127 000000EC 31 F6                           	XOR	ESI,ESI
   128 000000EE 68 0011D2D8                     	PUSH	1168088
   129 000000F3 BB 000003E7                     	MOV	EBX,999
   130 000000F8 E8 [00000000]                   	CALL	_mm_malloc
   131 000000FD A3 [00000008]                   	MOV	DWORD [_taskctl],EAX
   132 00000102 58                              	POP	EAX
   133 00000103                                 L39:
   134 00000103 89 F8                           	MOV	EAX,EDI
   135 00000105 8D 56 18                        	LEA	EDX,DWORD [24+ESI]
   136 00000108 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
   137 0000010E 81 C7 0000048C                  	ADD	EDI,1164
   138 00000114 C7 80 00001000 00000001         	MOV	DWORD [4096+EAX],1
   139 0000011E C7 80 00000FFC 00000000         	MOV	DWORD [4092+EAX],0
   140 00000128 89 90 00000FF8                  	MOV	DWORD [4088+EAX],EDX
   141 0000012E 05 0000141C                     	ADD	EAX,5148
   142 00000133 68 00000089                     	PUSH	137
   143 00000138 50                              	PUSH	EAX
   144 00000139 8D 86 00270018                  	LEA	EAX,DWORD [2555928+ESI]
   145 0000013F 6A 67                           	PUSH	103
   146 00000141 83 C6 08                        	ADD	ESI,8
   147 00000144 50                              	PUSH	EAX
   148 00000145 E8 [00000000]                   	CALL	_set_segmdesc
   149 0000014A 83 C4 10                        	ADD	ESP,16
   150 0000014D 4B                              	DEC	EBX
   151 0000014E 79 B3                           	JNS	L39
   152 00000150 8B 0D [00000008]                	MOV	ECX,DWORD [_taskctl]
   153 00000156 31 D2                           	XOR	EDX,EDX
   154 00000158 BB 00000009                     	MOV	EBX,9
   155 0000015D                                 L44:
   156 0000015D 8D 04 11                        	LEA	EAX,DWORD [ECX+EDX*1]
   157 00000160 81 C2 00000198                  	ADD	EDX,408
   158 00000166 4B                              	DEC	EBX
   159 00000167 C7 40 08 00000000               	MOV	DWORD [8+EAX],0
   160 0000016E C7 40 0C 00000000               	MOV	DWORD [12+EAX],0
   161 00000175 79 E6                           	JNS	L44
   162 00000177 E8 000000A4                     	CALL	_task_alloc
   163 0000017C 89 C6                           	MOV	ESI,EAX
   164 0000017E C7 40 04 00000002               	MOV	DWORD [4+EAX],2
   165 00000185 C7 40 0C 00000000               	MOV	DWORD [12+EAX],0
   166 0000018C 50                              	PUSH	EAX
   167 0000018D E8 FFFFFE8B                     	CALL	_task_add
   168 00000192 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
   169 00000197 C7 00 00000000                  	MOV	DWORD [EAX],0
   170 0000019D C6 40 04 00                     	MOV	BYTE [4+EAX],0
   171 000001A1 FF 36                           	PUSH	DWORD [ESI]
   172 000001A3 E8 [00000000]                   	CALL	_load_tr
   173 000001A8 E8 00000073                     	CALL	_task_alloc
   174 000001AD 6A 40                           	PUSH	64
   175 000001AF 89 C3                           	MOV	EBX,EAX
   176 000001B1 E8 [00000000]                   	CALL	_mm_malloc
   177 000001B6 83 C0 40                        	ADD	EAX,64
   178 000001B9 89 83 0000045C                  	MOV	DWORD [1116+EBX],EAX
   179 000001BF C7 83 00000444 [000000DA]       	MOV	DWORD [1092+EBX],_task_idle
   180 000001C9 C7 83 0000046C 00000008         	MOV	DWORD [1132+EBX],8
   181 000001D3 C7 83 00000470 00000010         	MOV	DWORD [1136+EBX],16
   182 000001DD C7 83 00000474 00000008         	MOV	DWORD [1140+EBX],8
   183 000001E7 C7 83 00000478 00000008         	MOV	DWORD [1144+EBX],8
   184 000001F1 C7 83 0000047C 00000008         	MOV	DWORD [1148+EBX],8
   185 000001FB C7 83 00000480 00000008         	MOV	DWORD [1152+EBX],8
   186 00000205 6A 00                           	PUSH	0
   187 00000207 6A 09                           	PUSH	9
   188 00000209 53                              	PUSH	EBX
   189 0000020A E8 000000EB                     	CALL	_task_run
   190 0000020F 89 F0                           	MOV	EAX,ESI
   191 00000211 C6 05 [00000000] 01             	MOV	BYTE [_mtask_on],1
   192 00000218 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   193 0000021B 5B                              	POP	EBX
   194 0000021C 5E                              	POP	ESI
   195 0000021D 5F                              	POP	EDI
   196 0000021E 5D                              	POP	EBP
   197 0000021F C3                              	RET
   198 00000220                                 	GLOBAL	_task_alloc
   199 00000220                                 _task_alloc:
   200 00000220 55                              	PUSH	EBP
   201 00000221 31 C9                           	XOR	ECX,ECX
   202 00000223 89 E5                           	MOV	EBP,ESP
   203 00000225 31 D2                           	XOR	EDX,EDX
   204 00000227 53                              	PUSH	EBX
   205 00000228                                 L55:
   206 00000228 89 D0                           	MOV	EAX,EDX
   207 0000022A 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
   208 00000230 83 B8 00000FFC 00               	CMP	DWORD [4092+EAX],0
   209 00000237 74 16                           	JE	L58
   210 00000239 41                              	INC	ECX
   211 0000023A 81 C2 0000048C                  	ADD	EDX,1164
   212 00000240 81 F9 000003E7                  	CMP	ECX,999
   213 00000246 7E E0                           	JLE	L55
   214 00000248 31 C0                           	XOR	EAX,EAX
   215 0000024A                                 L49:
   216 0000024A 8B 5D FC                        	MOV	EBX,DWORD [-4+EBP]
   217 0000024D C9                              	LEAVE
   218 0000024E C3                              	RET
   219 0000024F                                 L58:
   220 0000024F 8D 98 00000FF8                  	LEA	EBX,DWORD [4088+EAX]
   221 00000255 05 00001008                     	ADD	EAX,4104
   222 0000025A 50                              	PUSH	EAX
   223 0000025B E8 [00000000]                   	CALL	_fifo_init
   224 00000260 89 D8                           	MOV	EAX,EBX
   225 00000262 C7 43 04 00000001               	MOV	DWORD [4+EBX],1
   226 00000269 C7 83 00000448 00000202         	MOV	DWORD [1096+EBX],514
   227 00000273 C7 83 0000044C 00000000         	MOV	DWORD [1100+EBX],0
   228 0000027D C7 83 00000450 00000000         	MOV	DWORD [1104+EBX],0
   229 00000287 C7 83 00000454 00000000         	MOV	DWORD [1108+EBX],0
   230 00000291 C7 83 00000458 00000000         	MOV	DWORD [1112+EBX],0
   231 0000029B C7 83 00000460 00000000         	MOV	DWORD [1120+EBX],0
   232 000002A5 C7 83 00000464 00000000         	MOV	DWORD [1124+EBX],0
   233 000002AF C7 83 00000468 00000000         	MOV	DWORD [1128+EBX],0
   234 000002B9 C7 83 0000046C 00000000         	MOV	DWORD [1132+EBX],0
   235 000002C3 C7 83 00000478 00000000         	MOV	DWORD [1144+EBX],0
   236 000002CD C7 83 0000047C 00000000         	MOV	DWORD [1148+EBX],0
   237 000002D7 C7 83 00000480 00000000         	MOV	DWORD [1152+EBX],0
   238 000002E1 C7 83 00000484 00000000         	MOV	DWORD [1156+EBX],0
   239 000002EB C7 83 00000488 40000000         	MOV	DWORD [1160+EBX],1073741824
   240 000002F5 E9 FFFFFF50                     	JMP	L49
   241 000002FA                                 	GLOBAL	_task_run
   242 000002FA                                 _task_run:
   243 000002FA 55                              	PUSH	EBP
   244 000002FB 89 E5                           	MOV	EBP,ESP
   245 000002FD 56                              	PUSH	ESI
   246 000002FE 53                              	PUSH	EBX
   247 000002FF 8B 75 0C                        	MOV	ESI,DWORD [12+EBP]
   248 00000302 8B 45 10                        	MOV	EAX,DWORD [16+EBP]
   249 00000305 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
   250 00000308 85 F6                           	TEST	ESI,ESI
   251 0000030A 78 3B                           	JS	L64
   252 0000030C                                 L60:
   253 0000030C 85 C0                           	TEST	EAX,EAX
   254 0000030E 7E 03                           	JLE	L61
   255 00000310 89 43 08                        	MOV	DWORD [8+EBX],EAX
   256 00000313                                 L61:
   257 00000313 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   258 00000317 74 20                           	JE	L65
   259 00000319                                 L62:
   260 00000319 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   261 0000031D 74 0A                           	JE	L63
   262 0000031F 89 73 0C                        	MOV	DWORD [12+EBX],ESI
   263 00000322 53                              	PUSH	EBX
   264 00000323 E8 FFFFFCF5                     	CALL	_task_add
   265 00000328 5A                              	POP	EDX
   266 00000329                                 L63:
   267 00000329 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
   268 0000032E C6 40 04 01                     	MOV	BYTE [4+EAX],1
   269 00000332 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   270 00000335 5B                              	POP	EBX
   271 00000336 5E                              	POP	ESI
   272 00000337 5D                              	POP	EBP
   273 00000338 C3                              	RET
   274 00000339                                 L65:
   275 00000339 39 73 0C                        	CMP	DWORD [12+EBX],ESI
   276 0000033C 74 DB                           	JE	L62
   277 0000033E 53                              	PUSH	EBX
   278 0000033F E8 FFFFFD0C                     	CALL	_task_remove
   279 00000344 59                              	POP	ECX
   280 00000345 EB D2                           	JMP	L62
   281 00000347                                 L64:
   282 00000347 8B 73 0C                        	MOV	ESI,DWORD [12+EBX]
   283 0000034A EB C0                           	JMP	L60
   284                                          [SECTION .data]
   285 00000001 00 00 00                        	ALIGNB	4
   286 00000004                                 _tmr_count:
   287 00000004 00000000                        	DD	0
   288                                          [SECTION .text]
   289 0000034C                                 	GLOBAL	_task_switch
   290 0000034C                                 _task_switch:
   291 0000034C 55                              	PUSH	EBP
   292 0000034D 8B 0D [00000008]                	MOV	ECX,DWORD [_taskctl]
   293 00000353 89 E5                           	MOV	EBP,ESP
   294 00000355 57                              	PUSH	EDI
   295 00000356 56                              	PUSH	ESI
   296 00000357 53                              	PUSH	EBX
   297 00000358 8B 01                           	MOV	EAX,DWORD [ECX]
   298 0000035A 69 C0 00000198                  	IMUL	EAX,EAX,408
   299 00000360 8D 34 08                        	LEA	ESI,DWORD [EAX+ECX*1]
   300 00000363 A1 [00000004]                   	MOV	EAX,DWORD [_tmr_count]
   301 00000368 40                              	INC	EAX
   302 00000369 8D 56 08                        	LEA	EDX,DWORD [8+ESI]
   303 0000036C 8B 5A 04                        	MOV	EBX,DWORD [4+EDX]
   304 0000036F A3 [00000004]                   	MOV	DWORD [_tmr_count],EAX
   305 00000374 8B 7C 9A 08                     	MOV	EDI,DWORD [8+EDX+EBX*4]
   306 00000378 3B 47 08                        	CMP	EAX,DWORD [8+EDI]
   307 0000037B 74 08                           	JE	L72
   308 0000037D                                 L66:
   309 0000037D 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   310 00000380 5B                              	POP	EBX
   311 00000381 5E                              	POP	ESI
   312 00000382 5F                              	POP	EDI
   313 00000383 5D                              	POP	EBP
   314 00000384 C3                              	RET
   315 00000385                                 L72:
   316 00000385 8D 43 01                        	LEA	EAX,DWORD [1+EBX]
   317 00000388 C7 05 [00000004] 00000000       	MOV	DWORD [_tmr_count],0
   318 00000392 3B 46 08                        	CMP	EAX,DWORD [8+ESI]
   319 00000395 89 42 04                        	MOV	DWORD [4+EDX],EAX
   320 00000398 74 37                           	JE	L73
   321 0000039A                                 L69:
   322 0000039A 80 79 04 00                     	CMP	BYTE [4+ECX],0
   323 0000039E 75 18                           	JNE	L74
   324 000003A0                                 L70:
   325 000003A0 8B 42 04                        	MOV	EAX,DWORD [4+EDX]
   326 000003A3 8B 44 82 08                     	MOV	EAX,DWORD [8+EDX+EAX*4]
   327 000003A7 39 F8                           	CMP	EAX,EDI
   328 000003A9 74 D2                           	JE	L66
   329 000003AB FF 30                           	PUSH	DWORD [EAX]
   330 000003AD 6A 00                           	PUSH	0
   331 000003AF E8 [00000000]                   	CALL	_farjmp
   332 000003B4 5B                              	POP	EBX
   333 000003B5 5E                              	POP	ESI
   334 000003B6 EB C5                           	JMP	L66
   335 000003B8                                 L74:
   336 000003B8 E8 FFFFFCF6                     	CALL	_task_switchsub
   337 000003BD 8B 15 [00000008]                	MOV	EDX,DWORD [_taskctl]
   338 000003C3 8B 02                           	MOV	EAX,DWORD [EDX]
   339 000003C5 69 C0 00000198                  	IMUL	EAX,EAX,408
   340 000003CB 8D 54 10 08                     	LEA	EDX,DWORD [8+EAX+EDX*1]
   341 000003CF EB CF                           	JMP	L70
   342 000003D1                                 L73:
   343 000003D1 C7 42 04 00000000               	MOV	DWORD [4+EDX],0
   344 000003D8 EB C0                           	JMP	L69
   345 000003DA                                 	GLOBAL	_task_sleep
   346 000003DA                                 _task_sleep:
   347 000003DA 55                              	PUSH	EBP
   348 000003DB 89 E5                           	MOV	EBP,ESP
   349 000003DD 56                              	PUSH	ESI
   350 000003DE 53                              	PUSH	EBX
   351 000003DF 8B 75 08                        	MOV	ESI,DWORD [8+EBP]
   352 000003E2 83 7E 04 02                     	CMP	DWORD [4+ESI],2
   353 000003E6 74 07                           	JE	L78
   354 000003E8                                 L75:
   355 000003E8 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   356 000003EB 5B                              	POP	EBX
   357 000003EC 5E                              	POP	ESI
   358 000003ED 5D                              	POP	EBP
   359 000003EE C3                              	RET
   360 000003EF                                 L78:
   361 000003EF E8 FFFFFC0C                     	CALL	_task_now
   362 000003F4 56                              	PUSH	ESI
   363 000003F5 89 C3                           	MOV	EBX,EAX
   364 000003F7 E8 FFFFFC54                     	CALL	_task_remove
   365 000003FC 59                              	POP	ECX
   366 000003FD 39 DE                           	CMP	ESI,EBX
   367 000003FF 75 E7                           	JNE	L75
   368 00000401 E8 FFFFFCAD                     	CALL	_task_switchsub
   369 00000406 E8 FFFFFBF5                     	CALL	_task_now
   370 0000040B FF 30                           	PUSH	DWORD [EAX]
   371 0000040D 6A 00                           	PUSH	0
   372 0000040F E8 [00000000]                   	CALL	_farjmp
   373 00000414 58                              	POP	EAX
   374 00000415 5A                              	POP	EDX
   375 00000416 EB D0                           	JMP	L75
   376 00000418                                 	GLOBAL	_taskctl
   377                                          [SECTION .data]
   378 00000008                                 	ALIGNB	4
   379 00000008                                 _taskctl:
   380 00000008 00 00 00 00                     	RESB	4
