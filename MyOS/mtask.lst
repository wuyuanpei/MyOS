     1 00000000                                 [FORMAT "WCOFF"]
     2 00000000                                 [INSTRSET "i486p"]
     3 00000000                                 [OPTIMIZE 1]
     4 00000000                                 [OPTION 1]
     5 00000000                                 [BITS 32]
     6 00000000                                 	EXTERN	_io_hlt
     7 00000000                                 	EXTERN	_mm_malloc
     8 00000000                                 	EXTERN	_set_segmdesc
     9 00000000                                 	EXTERN	_load_tr
    10 00000000                                 	EXTERN	_farjmp
    11 00000000                                 [FILE "mtask.c"]
    12 00000000                                 	GLOBAL	_mtask_on
    13                                          [SECTION .data]
    14 00000000                                 _mtask_on:
    15 00000000 00                              	DB	0
    16                                          [SECTION .text]
    17 00000000                                 	GLOBAL	_task_now
    18 00000000                                 _task_now:
    19 00000000 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
    20 00000005 55                              	PUSH	EBP
    21 00000006 89 E5                           	MOV	EBP,ESP
    22 00000008 5D                              	POP	EBP
    23 00000009 8B 10                           	MOV	EDX,DWORD [EAX]
    24 0000000B 69 D2 00000198                  	IMUL	EDX,EDX,408
    25 00000011 8D 44 02 08                     	LEA	EAX,DWORD [8+EDX+EAX*1]
    26 00000015 8B 50 04                        	MOV	EDX,DWORD [4+EAX]
    27 00000018 8B 44 90 08                     	MOV	EAX,DWORD [8+EAX+EDX*4]
    28 0000001C C3                              	RET
    29 0000001D                                 _task_add:
    30 0000001D 55                              	PUSH	EBP
    31 0000001E 89 E5                           	MOV	EBP,ESP
    32 00000020 53                              	PUSH	EBX
    33 00000021 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
    34 00000024 8B 53 0C                        	MOV	EDX,DWORD [12+EBX]
    35 00000027 69 D2 00000198                  	IMUL	EDX,EDX,408
    36 0000002D 03 15 [00000008]                	ADD	EDX,DWORD [_taskctl]
    37 00000033 8B 42 08                        	MOV	EAX,DWORD [8+EDX]
    38 00000036 8D 4A 08                        	LEA	ECX,DWORD [8+EDX]
    39 00000039 83 F8 63                        	CMP	EAX,99
    40 0000003C 7F 0F                           	JG	L2
    41 0000003E 89 5C 81 08                     	MOV	DWORD [8+ECX+EAX*4],EBX
    42 00000042 40                              	INC	EAX
    43 00000043 89 42 08                        	MOV	DWORD [8+EDX],EAX
    44 00000046 C7 43 04 00000002               	MOV	DWORD [4+EBX],2
    45 0000004D                                 L2:
    46 0000004D 5B                              	POP	EBX
    47 0000004E 5D                              	POP	EBP
    48 0000004F C3                              	RET
    49 00000050                                 _task_remove:
    50 00000050 55                              	PUSH	EBP
    51 00000051 31 C9                           	XOR	ECX,ECX
    52 00000053 89 E5                           	MOV	EBP,ESP
    53 00000055 53                              	PUSH	EBX
    54 00000056 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
    55 00000059 8B 43 0C                        	MOV	EAX,DWORD [12+EBX]
    56 0000005C 69 C0 00000198                  	IMUL	EAX,EAX,408
    57 00000062 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
    58 00000068 8D 50 08                        	LEA	EDX,DWORD [8+EAX]
    59 0000006B 3B 48 08                        	CMP	ECX,DWORD [8+EAX]
    60 0000006E 7D 0B                           	JGE	L6
    61 00000070                                 L10:
    62 00000070 39 5C 8A 08                     	CMP	DWORD [8+EDX+ECX*4],EBX
    63 00000074 74 05                           	JE	L6
    64 00000076 41                              	INC	ECX
    65 00000077 3B 0A                           	CMP	ECX,DWORD [EDX]
    66 00000079 7C F5                           	JL	L10
    67 0000007B                                 L6:
    68 0000007B 8B 42 04                        	MOV	EAX,DWORD [4+EDX]
    69 0000007E FF 0A                           	DEC	DWORD [EDX]
    70 00000080 39 C1                           	CMP	ECX,EAX
    71 00000082 7D 04                           	JGE	L11
    72 00000084 48                              	DEC	EAX
    73 00000085 89 42 04                        	MOV	DWORD [4+EDX],EAX
    74 00000088                                 L11:
    75 00000088 8B 02                           	MOV	EAX,DWORD [EDX]
    76 0000008A 39 42 04                        	CMP	DWORD [4+EDX],EAX
    77 0000008D 7C 07                           	JL	L12
    78 0000008F C7 42 04 00000000               	MOV	DWORD [4+EDX],0
    79 00000096                                 L12:
    80 00000096 C7 43 04 00000001               	MOV	DWORD [4+EBX],1
    81 0000009D 8B 1A                           	MOV	EBX,DWORD [EDX]
    82 0000009F 39 D9                           	CMP	ECX,EBX
    83 000000A1 7D 0D                           	JGE	L20
    84 000000A3                                 L17:
    85 000000A3 8B 44 8A 0C                     	MOV	EAX,DWORD [12+EDX+ECX*4]
    86 000000A7 89 44 8A 08                     	MOV	DWORD [8+EDX+ECX*4],EAX
    87 000000AB 41                              	INC	ECX
    88 000000AC 39 D9                           	CMP	ECX,EBX
    89 000000AE 7C F3                           	JL	L17
    90 000000B0                                 L20:
    91 000000B0 5B                              	POP	EBX
    92 000000B1 5D                              	POP	EBP
    93 000000B2 C3                              	RET
    94 000000B3                                 _task_switchsub:
    95 000000B3 55                              	PUSH	EBP
    96 000000B4 31 C9                           	XOR	ECX,ECX
    97 000000B6 89 E5                           	MOV	EBP,ESP
    98 000000B8 A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
    99 000000BD 31 D2                           	XOR	EDX,EDX
   100 000000BF                                 L27:
   101 000000BF 83 7C 10 08 00                  	CMP	DWORD [8+EAX+EDX*1],0
   102 000000C4 7F 0C                           	JG	L23
   103 000000C6 41                              	INC	ECX
   104 000000C7 81 C2 00000198                  	ADD	EDX,408
   105 000000CD 83 F9 09                        	CMP	ECX,9
   106 000000D0 7E ED                           	JLE	L27
   107 000000D2                                 L23:
   108 000000D2 89 08                           	MOV	DWORD [EAX],ECX
   109 000000D4 C6 40 04 00                     	MOV	BYTE [4+EAX],0
   110 000000D8 5D                              	POP	EBP
   111 000000D9 C3                              	RET
   112 000000DA                                 _task_idle:
   113 000000DA 55                              	PUSH	EBP
   114 000000DB 89 E5                           	MOV	EBP,ESP
   115 000000DD                                 L33:
   116 000000DD E8 [00000000]                   	CALL	_io_hlt
   117 000000E2 EB F9                           	JMP	L33
   118 000000E4                                 	GLOBAL	_task_init
   119 000000E4                                 _task_init:
   120 000000E4 55                              	PUSH	EBP
   121 000000E5 89 E5                           	MOV	EBP,ESP
   122 000000E7 57                              	PUSH	EDI
   123 000000E8 56                              	PUSH	ESI
   124 000000E9 31 FF                           	XOR	EDI,EDI
   125 000000EB 53                              	PUSH	EBX
   126 000000EC 31 F6                           	XOR	ESI,ESI
   127 000000EE 68 0001E4B8                     	PUSH	124088
   128 000000F3 BB 000003E7                     	MOV	EBX,999
   129 000000F8 E8 [00000000]                   	CALL	_mm_malloc
   130 000000FD A3 [00000008]                   	MOV	DWORD [_taskctl],EAX
   131 00000102 58                              	POP	EAX
   132 00000103                                 L39:
   133 00000103 89 F8                           	MOV	EAX,EDI
   134 00000105 8D 56 18                        	LEA	EDX,DWORD [24+ESI]
   135 00000108 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
   136 0000010E 83 C7 78                        	ADD	EDI,120
   137 00000111 C7 80 00001000 00000001         	MOV	DWORD [4096+EAX],1
   138 0000011B C7 80 00000FFC 00000000         	MOV	DWORD [4092+EAX],0
   139 00000125 89 90 00000FF8                  	MOV	DWORD [4088+EAX],EDX
   140 0000012B 05 00001008                     	ADD	EAX,4104
   141 00000130 68 00000089                     	PUSH	137
   142 00000135 50                              	PUSH	EAX
   143 00000136 8D 86 00270018                  	LEA	EAX,DWORD [2555928+ESI]
   144 0000013C 6A 67                           	PUSH	103
   145 0000013E 83 C6 08                        	ADD	ESI,8
   146 00000141 50                              	PUSH	EAX
   147 00000142 E8 [00000000]                   	CALL	_set_segmdesc
   148 00000147 83 C4 10                        	ADD	ESP,16
   149 0000014A 4B                              	DEC	EBX
   150 0000014B 79 B6                           	JNS	L39
   151 0000014D 8B 0D [00000008]                	MOV	ECX,DWORD [_taskctl]
   152 00000153 31 D2                           	XOR	EDX,EDX
   153 00000155 BB 00000009                     	MOV	EBX,9
   154 0000015A                                 L44:
   155 0000015A 8D 04 11                        	LEA	EAX,DWORD [ECX+EDX*1]
   156 0000015D 81 C2 00000198                  	ADD	EDX,408
   157 00000163 4B                              	DEC	EBX
   158 00000164 C7 40 08 00000000               	MOV	DWORD [8+EAX],0
   159 0000016B C7 40 0C 00000000               	MOV	DWORD [12+EAX],0
   160 00000172 79 E6                           	JNS	L44
   161 00000174 E8 0000008C                     	CALL	_task_alloc
   162 00000179 89 C6                           	MOV	ESI,EAX
   163 0000017B C7 40 04 00000002               	MOV	DWORD [4+EAX],2
   164 00000182 C7 40 0C 00000000               	MOV	DWORD [12+EAX],0
   165 00000189 50                              	PUSH	EAX
   166 0000018A E8 FFFFFE8E                     	CALL	_task_add
   167 0000018F A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
   168 00000194 C7 00 00000000                  	MOV	DWORD [EAX],0
   169 0000019A C6 40 04 00                     	MOV	BYTE [4+EAX],0
   170 0000019E FF 36                           	PUSH	DWORD [ESI]
   171 000001A0 E8 [00000000]                   	CALL	_load_tr
   172 000001A5 E8 0000005B                     	CALL	_task_alloc
   173 000001AA 6A 40                           	PUSH	64
   174 000001AC 89 C3                           	MOV	EBX,EAX
   175 000001AE E8 [00000000]                   	CALL	_mm_malloc
   176 000001B3 83 C0 40                        	ADD	EAX,64
   177 000001B6 89 43 48                        	MOV	DWORD [72+EBX],EAX
   178 000001B9 C7 43 30 [000000DA]             	MOV	DWORD [48+EBX],_task_idle
   179 000001C0 C7 43 58 00000008               	MOV	DWORD [88+EBX],8
   180 000001C7 C7 43 5C 00000010               	MOV	DWORD [92+EBX],16
   181 000001CE C7 43 60 00000008               	MOV	DWORD [96+EBX],8
   182 000001D5 C7 43 64 00000008               	MOV	DWORD [100+EBX],8
   183 000001DC C7 43 68 00000008               	MOV	DWORD [104+EBX],8
   184 000001E3 C7 43 6C 00000008               	MOV	DWORD [108+EBX],8
   185 000001EA 6A 00                           	PUSH	0
   186 000001EC 6A 09                           	PUSH	9
   187 000001EE 53                              	PUSH	EBX
   188 000001EF E8 000000A9                     	CALL	_task_run
   189 000001F4 89 F0                           	MOV	EAX,ESI
   190 000001F6 C6 05 [00000000] 01             	MOV	BYTE [_mtask_on],1
   191 000001FD 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   192 00000200 5B                              	POP	EBX
   193 00000201 5E                              	POP	ESI
   194 00000202 5F                              	POP	EDI
   195 00000203 5D                              	POP	EBP
   196 00000204 C3                              	RET
   197 00000205                                 	GLOBAL	_task_alloc
   198 00000205                                 _task_alloc:
   199 00000205 55                              	PUSH	EBP
   200 00000206 31 C9                           	XOR	ECX,ECX
   201 00000208 89 E5                           	MOV	EBP,ESP
   202 0000020A 31 D2                           	XOR	EDX,EDX
   203 0000020C                                 L55:
   204 0000020C 89 D0                           	MOV	EAX,EDX
   205 0000020E 03 05 [00000008]                	ADD	EAX,DWORD [_taskctl]
   206 00000214 83 B8 00000FFC 00               	CMP	DWORD [4092+EAX],0
   207 0000021B 74 10                           	JE	L58
   208 0000021D 41                              	INC	ECX
   209 0000021E 83 C2 78                        	ADD	EDX,120
   210 00000221 81 F9 000003E7                  	CMP	ECX,999
   211 00000227 7E E3                           	JLE	L55
   212 00000229 31 C0                           	XOR	EAX,EAX
   213 0000022B                                 L49:
   214 0000022B 5D                              	POP	EBP
   215 0000022C C3                              	RET
   216 0000022D                                 L58:
   217 0000022D 05 00000FF8                     	ADD	EAX,4088
   218 00000232 C7 40 04 00000001               	MOV	DWORD [4+EAX],1
   219 00000239 C7 40 34 00000202               	MOV	DWORD [52+EAX],514
   220 00000240 C7 40 38 00000000               	MOV	DWORD [56+EAX],0
   221 00000247 C7 40 3C 00000000               	MOV	DWORD [60+EAX],0
   222 0000024E C7 40 40 00000000               	MOV	DWORD [64+EAX],0
   223 00000255 C7 40 44 00000000               	MOV	DWORD [68+EAX],0
   224 0000025C C7 40 4C 00000000               	MOV	DWORD [76+EAX],0
   225 00000263 C7 40 50 00000000               	MOV	DWORD [80+EAX],0
   226 0000026A C7 40 54 00000000               	MOV	DWORD [84+EAX],0
   227 00000271 C7 40 58 00000000               	MOV	DWORD [88+EAX],0
   228 00000278 C7 40 64 00000000               	MOV	DWORD [100+EAX],0
   229 0000027F C7 40 68 00000000               	MOV	DWORD [104+EAX],0
   230 00000286 C7 40 6C 00000000               	MOV	DWORD [108+EAX],0
   231 0000028D C7 40 70 00000000               	MOV	DWORD [112+EAX],0
   232 00000294 C7 40 74 40000000               	MOV	DWORD [116+EAX],1073741824
   233 0000029B EB 8E                           	JMP	L49
   234 0000029D                                 	GLOBAL	_task_run
   235 0000029D                                 _task_run:
   236 0000029D 55                              	PUSH	EBP
   237 0000029E 89 E5                           	MOV	EBP,ESP
   238 000002A0 56                              	PUSH	ESI
   239 000002A1 53                              	PUSH	EBX
   240 000002A2 8B 75 0C                        	MOV	ESI,DWORD [12+EBP]
   241 000002A5 8B 45 10                        	MOV	EAX,DWORD [16+EBP]
   242 000002A8 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
   243 000002AB 85 F6                           	TEST	ESI,ESI
   244 000002AD 78 3B                           	JS	L64
   245 000002AF                                 L60:
   246 000002AF 85 C0                           	TEST	EAX,EAX
   247 000002B1 7E 03                           	JLE	L61
   248 000002B3 89 43 08                        	MOV	DWORD [8+EBX],EAX
   249 000002B6                                 L61:
   250 000002B6 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   251 000002BA 74 20                           	JE	L65
   252 000002BC                                 L62:
   253 000002BC 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   254 000002C0 74 0A                           	JE	L63
   255 000002C2 89 73 0C                        	MOV	DWORD [12+EBX],ESI
   256 000002C5 53                              	PUSH	EBX
   257 000002C6 E8 FFFFFD52                     	CALL	_task_add
   258 000002CB 5A                              	POP	EDX
   259 000002CC                                 L63:
   260 000002CC A1 [00000008]                   	MOV	EAX,DWORD [_taskctl]
   261 000002D1 C6 40 04 01                     	MOV	BYTE [4+EAX],1
   262 000002D5 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   263 000002D8 5B                              	POP	EBX
   264 000002D9 5E                              	POP	ESI
   265 000002DA 5D                              	POP	EBP
   266 000002DB C3                              	RET
   267 000002DC                                 L65:
   268 000002DC 39 73 0C                        	CMP	DWORD [12+EBX],ESI
   269 000002DF 74 DB                           	JE	L62
   270 000002E1 53                              	PUSH	EBX
   271 000002E2 E8 FFFFFD69                     	CALL	_task_remove
   272 000002E7 59                              	POP	ECX
   273 000002E8 EB D2                           	JMP	L62
   274 000002EA                                 L64:
   275 000002EA 8B 73 0C                        	MOV	ESI,DWORD [12+EBX]
   276 000002ED EB C0                           	JMP	L60
   277                                          [SECTION .data]
   278 00000001 00 00 00                        	ALIGNB	4
   279 00000004                                 _tmr_count:
   280 00000004 00000000                        	DD	0
   281                                          [SECTION .text]
   282 000002EF                                 	GLOBAL	_task_switch
   283 000002EF                                 _task_switch:
   284 000002EF 55                              	PUSH	EBP
   285 000002F0 8B 0D [00000008]                	MOV	ECX,DWORD [_taskctl]
   286 000002F6 89 E5                           	MOV	EBP,ESP
   287 000002F8 57                              	PUSH	EDI
   288 000002F9 56                              	PUSH	ESI
   289 000002FA 53                              	PUSH	EBX
   290 000002FB 8B 01                           	MOV	EAX,DWORD [ECX]
   291 000002FD 69 C0 00000198                  	IMUL	EAX,EAX,408
   292 00000303 8D 34 08                        	LEA	ESI,DWORD [EAX+ECX*1]
   293 00000306 A1 [00000004]                   	MOV	EAX,DWORD [_tmr_count]
   294 0000030B 40                              	INC	EAX
   295 0000030C 8D 56 08                        	LEA	EDX,DWORD [8+ESI]
   296 0000030F 8B 5A 04                        	MOV	EBX,DWORD [4+EDX]
   297 00000312 A3 [00000004]                   	MOV	DWORD [_tmr_count],EAX
   298 00000317 8B 7C 9A 08                     	MOV	EDI,DWORD [8+EDX+EBX*4]
   299 0000031B 3B 47 08                        	CMP	EAX,DWORD [8+EDI]
   300 0000031E 74 08                           	JE	L72
   301 00000320                                 L66:
   302 00000320 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   303 00000323 5B                              	POP	EBX
   304 00000324 5E                              	POP	ESI
   305 00000325 5F                              	POP	EDI
   306 00000326 5D                              	POP	EBP
   307 00000327 C3                              	RET
   308 00000328                                 L72:
   309 00000328 8D 43 01                        	LEA	EAX,DWORD [1+EBX]
   310 0000032B C7 05 [00000004] 00000000       	MOV	DWORD [_tmr_count],0
   311 00000335 3B 46 08                        	CMP	EAX,DWORD [8+ESI]
   312 00000338 89 42 04                        	MOV	DWORD [4+EDX],EAX
   313 0000033B 74 37                           	JE	L73
   314 0000033D                                 L69:
   315 0000033D 80 79 04 00                     	CMP	BYTE [4+ECX],0
   316 00000341 75 18                           	JNE	L74
   317 00000343                                 L70:
   318 00000343 8B 42 04                        	MOV	EAX,DWORD [4+EDX]
   319 00000346 8B 44 82 08                     	MOV	EAX,DWORD [8+EDX+EAX*4]
   320 0000034A 39 F8                           	CMP	EAX,EDI
   321 0000034C 74 D2                           	JE	L66
   322 0000034E FF 30                           	PUSH	DWORD [EAX]
   323 00000350 6A 00                           	PUSH	0
   324 00000352 E8 [00000000]                   	CALL	_farjmp
   325 00000357 5B                              	POP	EBX
   326 00000358 5E                              	POP	ESI
   327 00000359 EB C5                           	JMP	L66
   328 0000035B                                 L74:
   329 0000035B E8 FFFFFD53                     	CALL	_task_switchsub
   330 00000360 8B 15 [00000008]                	MOV	EDX,DWORD [_taskctl]
   331 00000366 8B 02                           	MOV	EAX,DWORD [EDX]
   332 00000368 69 C0 00000198                  	IMUL	EAX,EAX,408
   333 0000036E 8D 54 10 08                     	LEA	EDX,DWORD [8+EAX+EDX*1]
   334 00000372 EB CF                           	JMP	L70
   335 00000374                                 L73:
   336 00000374 C7 42 04 00000000               	MOV	DWORD [4+EDX],0
   337 0000037B EB C0                           	JMP	L69
   338 0000037D                                 	GLOBAL	_task_sleep
   339 0000037D                                 _task_sleep:
   340 0000037D 55                              	PUSH	EBP
   341 0000037E 89 E5                           	MOV	EBP,ESP
   342 00000380 56                              	PUSH	ESI
   343 00000381 53                              	PUSH	EBX
   344 00000382 8B 75 08                        	MOV	ESI,DWORD [8+EBP]
   345 00000385 83 7E 04 02                     	CMP	DWORD [4+ESI],2
   346 00000389 74 07                           	JE	L78
   347 0000038B                                 L75:
   348 0000038B 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   349 0000038E 5B                              	POP	EBX
   350 0000038F 5E                              	POP	ESI
   351 00000390 5D                              	POP	EBP
   352 00000391 C3                              	RET
   353 00000392                                 L78:
   354 00000392 E8 FFFFFC69                     	CALL	_task_now
   355 00000397 56                              	PUSH	ESI
   356 00000398 89 C3                           	MOV	EBX,EAX
   357 0000039A E8 FFFFFCB1                     	CALL	_task_remove
   358 0000039F 59                              	POP	ECX
   359 000003A0 39 DE                           	CMP	ESI,EBX
   360 000003A2 75 E7                           	JNE	L75
   361 000003A4 E8 FFFFFD0A                     	CALL	_task_switchsub
   362 000003A9 E8 FFFFFC52                     	CALL	_task_now
   363 000003AE FF 30                           	PUSH	DWORD [EAX]
   364 000003B0 6A 00                           	PUSH	0
   365 000003B2 E8 [00000000]                   	CALL	_farjmp
   366 000003B7 58                              	POP	EAX
   367 000003B8 5A                              	POP	EDX
   368 000003B9 EB D0                           	JMP	L75
   369 000003BB                                 	GLOBAL	_taskctl
   370                                          [SECTION .data]
   371 00000008                                 	ALIGNB	4
   372 00000008                                 _taskctl:
   373 00000008 00 00 00 00                     	RESB	4
